---
version: '3.8'

services:
  redis:
    image: redis:{{ redis_version }}
    container_name: redis
    restart: unless-stopped
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - {{ redis_data_dir }}:/data
      - {{ redis_config_dir }}/redis.conf:/usr/local/etc/redis/redis.conf:ro
{% if redis_expose_port | default(false) %}
    ports:
      - "{{ redis_host_port }}:6379"
{% endif %}
{% if redis_networks | default([]) | length > 0 %}
    networks:
{% for network in redis_networks %}
      - {{ network }}
{% endfor %}
{% endif %}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "{{ redis_password }}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
{% if redis_networks | default([]) | length > 0 %}
    labels:
      - "traefik.enable=true"

      # TCP 라우터 설정 (TLS Termination)
      - "traefik.tcp.routers.redis.rule=HostSNI(`{{ domain }}`)"
      - "traefik.tcp.routers.redis.tls=true"
      - "traefik.tcp.routers.redis.tls.certresolver=letsencrypt"
      - "traefik.tcp.routers.redis.entrypoints=redis"
      - "traefik.tcp.routers.redis.service=redis-svc"

      # TCP 서비스 설정
      - "traefik.tcp.services.redis-svc.loadbalancer.server.port=6379"
{% endif %}

{% if redis_networks | default([]) | length > 0 %}
networks:
{% for network in redis_networks %}
  {{ network }}:
    external: true
{% endfor %}
{% endif %}
