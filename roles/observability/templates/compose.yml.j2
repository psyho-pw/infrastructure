services:
  prometheus:
    image: prom/prometheus:{{ prometheus_version }}
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time={{ prometheus_retention_time }}'
      - '--web.external-url=https://${DOMAIN}/prometheus'
      - '--web.route-prefix=/prometheus'
    expose:
      - "9090"
    volumes:
      - {{ observability_dir }}/prometheus/config:/etc/prometheus:ro
      - {{ observability_dir }}/prometheus/data:/prometheus
    networks:
      - {{ traefik_network }}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"

      # HTTP router (redirect)
      - "traefik.http.routers.prometheus-http.rule=Host(`${DOMAIN}`) && PathPrefix(`/prometheus`)"
      - "traefik.http.routers.prometheus-http.entrypoints=web"
      - "traefik.http.routers.prometheus-http.middlewares=redirect-to-https@docker"

      # HTTPS router (main)
      - "traefik.http.routers.prometheus.rule=Host(`${DOMAIN}`) && PathPrefix(`/prometheus`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls.certresolver=letsencrypt"
{% if prometheus_basic_auth is defined %}
      - "traefik.http.routers.prometheus.middlewares=prometheus-auth"
      - "traefik.http.middlewares.prometheus-auth.basicauth.users=${PROMETHEUS_AUTH}"
{% endif %}
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

  loki:
    image: grafana/loki:{{ loki_version }}
    container_name: loki
    command: -config.file=/etc/loki/loki-config.yml
    expose:
      - "3100"
    volumes:
      - {{ observability_dir }}/loki/config:/etc/loki:ro
      - {{ observability_dir }}/loki/data:/loki
    networks:
      - {{ traefik_network }}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"

      # HTTP router (redirect)
      - "traefik.http.routers.loki-http.rule=Host(`${DOMAIN}`) && PathPrefix(`/loki`)"
      - "traefik.http.routers.loki-http.entrypoints=web"
      - "traefik.http.routers.loki-http.middlewares=redirect-to-https@docker"

      # HTTPS router (main)
      - "traefik.http.routers.loki.rule=Host(`${DOMAIN}`) && PathPrefix(`/loki`)"
      - "traefik.http.routers.loki.entrypoints=websecure"
      - "traefik.http.routers.loki.tls.certresolver=letsencrypt"
{% if loki_basic_auth is defined %}
      - "traefik.http.routers.loki.middlewares=loki-auth,loki-stripprefix"
      - "traefik.http.middlewares.loki-auth.basicauth.users=${LOKI_AUTH}"
{% else %}
      - "traefik.http.routers.loki.middlewares=loki-stripprefix"
{% endif %}
      - "traefik.http.middlewares.loki-stripprefix.stripprefix.prefixes=/loki"
      - "traefik.http.services.loki.loadbalancer.server.port=3100"

  grafana:
    image: grafana/grafana:{{ grafana_version }}
    container_name: grafana
    environment:
      - GF_SERVER_ROOT_URL=https://${DOMAIN}/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    expose:
      - "3000"
    volumes:
      - {{ observability_dir }}/grafana/data:/var/lib/grafana
      - {{ observability_dir }}/grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - {{ traefik_network }}
    restart: unless-stopped
    labels:
      - "traefik.enable=true"

      # HTTP router (redirect)
      - "traefik.http.routers.grafana-http.rule=Host(`${DOMAIN}`) && PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana-http.entrypoints=web"
      - "traefik.http.routers.grafana-http.middlewares=redirect-to-https@docker"

      # HTTPS router (main)
      - "traefik.http.routers.grafana.rule=Host(`${DOMAIN}`) && PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

networks:
  {{ traefik_network }}:
    name: {{ traefik_network }}
    external: true
